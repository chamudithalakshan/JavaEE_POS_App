<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <link href="../assets/css/bootstrap.css" rel="stylesheet">


</head>
<header>
    <!--nav logo-->
    <nav class="navbar navbar-expand-lg bg-light" style="background-color: #6c757d">
        <div class="container-fluid shadow p-3 mb-3 bg-body rounded">
            <img height="70" src="../assets/image/shopping-cart-svg-png-icon-download-28.png"
                 width="70">
            <a class="navbar-brand" href="#"> Food Store</a>
            <button aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation"
                    class="navbar-toggler" data-bs-target="#navbarSupportedContent"
                    data-bs-toggle="collapse" type="button">
                <span class="navbar-toggler-icon"></span>
            </button>

            <!--links-->
            <div class="collapse navbar-collapse" id="navbarSupportedContent">
                <ul class="navbar-nav me-auto mb-2 mb-lg-0">
                    <li class="nav-item">
                        <a aria-current="page" class="nav-link active" href="../index.html" id="home">Home</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="Customer.html" id="customer">Customers</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="Item.html" id="item">Items</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="placeOrder.html" id="placeOrder">Place Order</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#AllOrderform" id="allOrder">All Order details</a>
                    </li>
                </ul>

                <!--login logout-->
                <ul class="navbar-nav me-6 mb-2 mb-lg-0">
                    <li class="nav-item">
                        <a aria-current="page" class="nav-link" href="#"></i>
                            Sign Up</a>
                    </li>
                    <li class="nav-item">
                        <a aria-current="page" class="nav-link" href="#"></i>
                            Log Out</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>
</header>

<body>
<main class="container-fluid" id="PlaceOrderform">
    <h1>PLACE ORDER</h1>

    <section class="row justify-content-center">
        <div class="row justify-content-evenly ">

            <!--invoice section-->
            <div class="col-10 col-md-9 col-lg-3 p-3 mt-1 bg-white shadow-lg " style="height: max-content">
                <h3 class="text-center bg-success p-2 text-light ">Invoice</h3>
                <div class="row mt-1">
                    <div class="col-12 col-md-6 col-lg-6">
                        <label class="form-label" for="orderId">Order ID:</label>
                        <input class="form-control" id="orderId" type="text">
                    </div>
                    <div class="col-12 col-md-6 col-lg-6">
                        <label class="form-label" for="orderDate">Order Date:</label>
                        <input class="form-control" id="orderDate" type="date">
                    </div>
                </div>
                <div class="row mt-1">
                    <div class="col-12 col-md-6 col-lg-6">
                        <label class="form-label" for="inputCustomerID">Customer ID:</label>
                        <select aria-label="Default select example" class="form-select" id="inputCustomerID"
                                onchange=setDetails(this.value)>
                        </select>
                    </div>
                    <div class="col-12 col-md-6 col-lg-6">
                        <label class="form-label" for="customerName">Name:</label>
                        <input class="form-control" disabled id="customerName" type="text">
                    </div>
                </div>
                <div class="row mt-1">
                    <div class="col-12 col-md-6 col-lg-6">
                        <label class="form-label" for="customerAddress">Address:</label>
                        <input class="form-control" disabled id="customerAddress" type="text">
                    </div>
                    <div class="col-12 col-md-6 col-lg-6">
                        <label class="form-label" for="customerSalary">Salary:</label>
                        <input class="form-control" disabled id="customerSalary" type="text">
                    </div>
                </div>
            </div>

            <!--items-->
            <div class="col-10 col-md-5 col-lg-3 p-3 mt-1 bg-white shadow-lg " style="height: max-content">
                <h3 class="text-center bg-success p-2 text-light">Items</h3>
                <div class="row mt-1">
                    <div class="col-12 col-md-6 col-lg-6">
                        <label class="form-label" for="inputItemCode">Item Code:</label>
                        <select aria-label="Default select example" class="form-select" id="inputItemCode"
                                onchange="setIDetails(this.value)">
                            <option selected>Select Item</option>
                        </select>
                    </div>
                    <div class="col-12 col-md-6 col-lg-6">
                        <label class="form-label" for="itemName">Item Name:</label>
                        <input class="form-control" disabled id="itemName" type="text">


                    </div>
                </div>
                <div class="row mt-1">
                    <div class="col-12 col-md-6 col-lg-6">
                        <label class="form-label" for="itemPrice">Unit Price:</label>
                        <input class="form-control" disabled id="itemPrice" type="text">
                    </div>
                    <div class="col-12 col-md-6 col-lg-6">
                        <label class="form-label" for="qtyOnHand">Qty On Hand:</label>
                        <input class="form-control" disabled id="qtyOnHand" type="text">
                    </div>
                </div>
                <div class="row mt-1">
                    <div class="col-12 col-md-6 col-lg-6">
                        <label class="form-label" for="buyQty">Order Quntity:</label>
                        <input class="form-control small" id="buyQty" type="text">
                    </div>
                    <div class="col-12 col-md-6 col-lg-6"><br>
                        <button class="btn btn-warning rounded-5" id="btnAddToCart" type="submit">Add to Cart</button>
                    </div>
                </div>
            </div>

            <!--total price-->
            <div class="col-10 col-md-10 col-lg-3 p-3 mt-3 bg-white shadow-lg" style="height: max-content">
                <div class="row">
                    <div class="col-12 col-md-12 col-lg-12">
                        <h3 class="text-start p-1">Total: <span class="text-start text-danger" id="rupees">Rs. <span
                                class="text-start text-danger" id="txtTotal"></span></span>
                        </h3>
                    </div>
                </div>
                <div class="row">
                    <div class="col-12 col-md-6 col-lg-6">
                        <label class="form-label" for="txtCash">Cash (Rs.):</label>
                        <input class="form-control" id="txtCash" type="text">
                    </div>
                    <div class="col-12 col-md-6 col-lg-6">
                        <label class="form-label" for="txtDiscount">Discount:</label>
                        <input class="form-control" id="txtDiscount" type="text">
                    </div>
                </div>
                <div class="row">
                    <div class="col-12 col-md-12 col-lg-12">
                        <h3 class="text-start p-1">Sub Total: Rs. <span class="text-center p-1" id="txtSubTotal"></span>
                        </h3>
                    </div>
                </div>
                <div class="row">
                    <div class="col-12 col-md-12 col-lg-12">
                        <label class="form-label" for="txtBalance">Balance (Rs.):</label>
                        <input class="form-control" disabled id="txtBalance" type="text">
                    </div>
                </div>
                <br>
                <div class="row">
                    <button class="btn btn-danger rounded-5" id="btnPlaceOrder" type="submit">Place Order</button>
                </div>
            </div>

            <!-- add to cart table-->
            <section class="container-fluid mt-4">
                <table class="table table-striped">
                    <thead class="table-success">
                    <tr>
                        <th scope="col">Item Code</th>
                        <th scope="col">Item Name</th>
                        <th scope="col">Unit Price</th>
                        <th scope="col">QTY</th>
                        <th scope="col">Total</th>
                    </tr>
                    </thead>
                    <tbody id="orderTable">


                    </tbody>
                </table>
            </section>
        </div>
    </section>
</main>


<script src="../assets/js/bootstrap.js"></script>
<script src="../assets/js/jquery-3.6.1.min.js"></script>

<script>

    function loadCid() {
        $.ajax({
            url: 'http://localhost:8080/asignment/pages/customer',
            success: function (customer) {
                console.log(customer)
                $.each(customer, function (index, value) {
                    $('#inputCustomerID').append($('<option>', {
                        value: value.cid,
                        text: value.cid
                    }));
                });
            },
            error: function (error) {
                console.log(error);
            }
        });

    }

    function loadItemId() {
        $.ajax({
            url: 'http://localhost:8080/asignment/pages/item',
            success: function (item) {
                // console.log(customer)
                $.each(item, function (index, value) {
                    $('#inputItemCode').append($('<option>', {
                        value: value.code,
                        text: value.code
                    }));
                });
            },
            error: function (error) {
                console.log(error);
            }
        });

    }

    function setDetails(value) {
        $.ajax({
            url: 'http://localhost:8080/asignment/pages/customer/' + value,
            success: function (customerDetails) {
                if (customerDetails) {
                    $('#customerName').val(customerDetails.name);
                    $('#customerAddress').val(customerDetails.address);
                    $('#customerSalary').val(customerDetails.salary);
                } else {
                    console.log("No customer details found for customer ID:", value);
                }
            },
            error: function (error) {
                console.log("Error fetching customer details:", error);
            }
        });
    }

    function setIDetails(value) {
        $.ajax({
            url: 'http://localhost:8080/asignment/pages/item/' + value,
            success: function (itemDetails) {
                if (itemDetails) {
                    $('#itemName').val(itemDetails.itemName);
                    $('#itemPrice').val(itemDetails.unitPrice);
                    $('#qtyOnHand').val(itemDetails.quantity);
                } else {
                    console.log("No item details found for item code:", value);
                }
            },
            error: function (error) {
                console.log("Error fetching item details:", error);
            }
        });
    }

    $(document).ready(function () {
        const newOrderId = generateOrderId();
        $('#orderId').val(newOrderId);
    });

    function generateOrderId() {
        return 'ORD-' + (new Date().getTime().toString(16) + Math.floor(1000 * Math.random()).toString(16));
    }


    loadCid();
    loadItemId();

    $("#btnAddToCart").click(function () {
        let itemCode = $("#inputItemCode").val();
        let itemName = $("#itemName").val();
        let itmPrice = $("#itemPrice").val();
        let qty = $("#buyQty").val();
        let total = itmPrice * qty;


        let existingRow = $("#orderTable").find(`tr[data-item-code='${itemCode}']`);

        if (existingRow.length) {

            let currentQty = parseInt(existingRow.find("td:eq(3)").text(), 10);
            let currentTotal = parseInt(existingRow.find("td:eq(4)").text(), 10);
            existingRow.find("td:eq(3)").text(currentQty + parseInt(qty, 10));
            existingRow.find("td:eq(4)").text(currentTotal + parseInt(total, 10));
        } else {

            let row = `<tr data-item-code="${itemCode}"><td>${itemCode}</td><td>${itemName}</td><td>${itmPrice}</td><td>${qty}</td><td>${total}</td></tr>`;
            $("#orderTable").append(row);
        }


        let fullTotal = 0;
        $("#orderTable tr").each(function () {
            let rowTotal = parseFloat($(this).find("td:eq(4)").text());
            fullTotal += rowTotal;
        });


        $("#txtTotal").text(fullTotal.toFixed(2));


    });


    function calculateSubTotal() {

        let fullTotal = 0;
        $("#orderTable tr").each(function () {
            let rowTotal = parseFloat($(this).find("td:eq(4)").text());
            fullTotal += rowTotal;
        });


        let discountAmount = parseFloat($("#txtDiscount").val());
        let subtotal = fullTotal - discountAmount;


        if (subtotal < 0) {
            subtotal = 0;
        }


        $("#txtSubTotal").text(subtotal.toFixed(2));
    }


    function calculateBalance() {

        let fullTotal = 0;
        $("#orderTable tr").each(function () {
            let rowTotal = parseFloat($(this).find("td:eq(4)").text());
            fullTotal += rowTotal;
        });


        let discountAmount = parseFloat($("#txtDiscount").val());
        let amountAfterDiscount = fullTotal - discountAmount;


        if (amountAfterDiscount < 0) {
            amountAfterDiscount = 0;
        }


        let cashGiven = parseFloat($("#txtCash").val());
        let balance = cashGiven - amountAfterDiscount;


        $("#txtBalance").val(balance.toFixed(2));
    }

    function placeOrder() {

        // 1. Gather data
        let customerID = $('#inputCustomerID').val();
        let orderDate = $('#orderDate').val();
        let totalAmount = $('#txtSubTotal').text();

        let items = [];
        $("#orderTable tr").each(function () {
            let itemCode = $(this).find("td:eq(0)").text();
            let itemName = $(this).find("td:eq(1)").text();
            let unitPrice = $(this).find("td:eq(2)").text();
            let quantity = $(this).find("td:eq(3)").text();
            items.push({
                code: itemCode,
                name: itemName,
                price: unitPrice,
                qty: quantity
            });

        });
let oid = $("#orderId").val();

        let orderData = {
            orderId:oid,
            customerID: customerID,
            date: orderDate,
            total: totalAmount,
            items: items
        };
        console.log(orderData);

        // 2. Send data to the server

        $.ajax({
            url: 'http://localhost:8080/asignment/pages/placeOrder',
            method: 'post',
            data: JSON.stringify(orderData),
            contentType: 'application/json',
            success: function (response) {
                if (response.success) {
                    alert('Order placed successfully!');
                } else {
                    alert('Error placing order: ' + response.message);
                }
            },
            error: function (err) {
                alert('Error connecting to server.');
            }
        });
    }

    // Assuming you have a button with id 'btnPlaceOrder'
    $("#btnPlaceOrder").click(placeOrder);


    $("#txtDiscount").keydown(function (event) {

        if (event.keyCode == 13) {
            event.preventDefault();


            calculateSubTotal();
            calculateBalance();
        }
    });

</script>

</body>
</html>